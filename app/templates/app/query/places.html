{% extends 'app/base.html' %}
{% load app_tags %}

{% block title %}
    {{ query.name }}
{% endblock %}


{% block style %}
    <style>
        .place_little_card:hover .top_place_number {
            opacity: 1;
        }

        .top_place_number {
            position: absolute;
            opacity: 0;
            width: 50px;
            transition: opacity .3s;
            padding: 10px;
            background-color: white;
            color: cornflowerblue;
            text-align: center;
            z-index: 999 !important;
        }

        .number_right {
            margin-left: 250px;
            background: white;
            font-weight: 600;
        }
    </style>
{% endblock %}
{% block content %}
    <h4 class="block_title"> {{ query.name }} </h4>
    <div class="columns is-centered is-multiline">
        {% for place in top_places %}
            <div class="column is-9 " style="padding: 10px; box-sizing: border-box">
                <div class="box place_little_card">
                    <span class="top_place_number">{{ forloop.counter }}</span>
                    <span class="top_place_number number_right" style="color:gold;">{{ place.rating }}</span>
                    <div style="display: flex; ">
                        <a href="{{ place.get_absolute_url }}"><img src="{{ place.img|getImg }}" alt=""
                                                                    style="width: 300px !important; height: 200px !important; max-height: 100%;margin-right: 20px"></a>
                        <div style="flex-grow: 1; width: min-content">
                        <span style="color: black;
    text-align: center;
    display: block;
    border-bottom: 1px solid grey;margin: 0px;
;">
                            <a href="{{ place.get_absolute_url }}">{{ place.name }}</a></span>
                            <span><b>Рейтинг</b>: {{ place.rating }} ({{ place.rating_user_count }})</span><br>
                            <span><b>Адрес</b>: {{ place.address|isValue }}</span><br>
                            <span><b>Телефон</b>: <a
                                    href="tel:{{ place.phone_number }}">{{ place.phone_number|isValue }}</a></span><br>
                            <span><b>Описание</b>:
                                {% if place.description %}{{ place.description|truncatechars:200 }}{% else %}
                                    {{ place.get_meta_description|truncatechars:200 }}{% endif %}</span><br>

                        </div>
                    </div>
                    {% with place.reviews_google|getMoreText as review %}
                        {% if review %}
                            <div style="margin: 10px auto">
                                <b>Отзыв: </b>
                                <span style="border-bottom: 1px dashed lightgray;border-top:1px dashed lightgray; padding: 10px;width: 100%;display:block;">

                                        <div class="columns">
                                            <div class="column ">
                                            <span class="author"
                                                  style="display: flex; justify-content: space-between; width:auto;"><b>{{ review.author_name }}</b><span>
                                                {{ review.rating|getRating|safe }}
                                            </span>
                                            </span>
                                                <span class="text">{{ review.text }}</span>
                                            </div>
                                        </div>
                            </span>
                            </div>
                        {% endif %}
                    {% endwith %}
                    <span>Отзывов: {{ place.reviews_google.count|add:place.reviews.count }}</span>
                </div>
            </div>
        {% endfor %}
    </div>
    <hr>
    <div class="columns is-centered">
        <div class="column is-9">
            <h4 style="text-align: center">Описание</h4>
            {% if request.user|hasGroup:'Администратор' %}
                <a href="{% url 'app:query_edit' query.slug %}" class="button is-success is-light is-outlined centered"
                   style="width: fit-content">Редактировать</a>
            {% endif %}
            <div>
                {{ query.content|isValue:'<span style="color: grey; margin: 10px auto; display: block; width: fit-content;">Описание не найдено</span>'|safe }}
            </div>
            <br>
            <div style="display:flex; justify-content: center">
                {% for tag in query.tags.all %}
                    <span class="tag is-medium is-info" style="margin: 3px;">{{ tag.name }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
    <hr>

    <h4 class="block_title">Весь список</h4>
    <div class="columns is-multiline">
        {% for letter in letters %}
            <div class="column is-3">
                <hr>
                <span style="color: cornflowerblue">{{ letter }}</span>
                {% for place in places_letter|getValue:letter|getValue:'places' %}
                    <p><a href="{{ place.get_absolute_url }}" class="hover_link">{{ place.name }}</a></p>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
    <hr>
    <div style="color: grey">
        <p>Всего {{ places.count }} объектов</p>
    </div>
{% endblock %}